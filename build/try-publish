#!/usr/bin/env bash

#
# Try publishing packages
#
# https://github.com/primer/primer/blob/master/script/try-publish
#

set -e

if [ $# -ne 1 ]; then
  echo "Available packages"
  ls -1 packages/
fi

packageName="${1:?Missing first argument}"

command -v jq >/dev/null 2>&1 || { echo >&2 "Required binary jq not found. This script will not work. Aborting."; exit 1; }
command -v yarn >/dev/null 2>&1 || { echo >&2 "Required binary yarn not found. This script will not work. Aborting."; exit 1; }

package=$(jq -r .name packages/${packageName}/package.json)
version=$(jq -r .version packages/${packageName}/package.json)

echo "Checking if ${package} is already published at version ${version}"

published=$(yarn info $package@$version version)
if [[ "$version" = "$published" ]]; then
  echo "⚠️   $package@$version is already published!"
else
  echo "📦  Publishing: $package@$version (published: $published)"
  cd packages/$@/ && \
  yarn publish --mutex network \
               --no-git-tag-version \
               --verbose \
               --registry https://nexus.unify360.cgi.com:50043/repository/npm-hosted/ && \
  cd ../../
fi
